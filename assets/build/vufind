#!/bin/bash

useradd --create-home --home-dir /home/vufind2 --shell /bin/bash vufind2

su - vufind2 -c "mkdir /home/vufind2/bin"

wget -qO - https://getcomposer.org/installer | su - vufind2 -c "php -- --install-dir=/home/vufind2/bin --filename=composer"

cat >>/home/vufind2/.bashrc <<EOF
export JAVA_HOME="/usr/lib/jvm/default-java"
export VUFIND_HOME="${VUFIND_HOME}"
export VUFIND_LOCAL_DIR="${VUFIND_HOME}/local"
export PHP_IDE_CONFIG="serverName=localhost"
export XDEBUG_CONFIG="idekey=phpstorm"
EOF

pear upgrade pear
pear channel-discover pear.phing.info
pear channel-update pear.phing.info
pear install --onlyreqdeps phing/phing


cat <<EOF >/etc/apache2/sites-available/vufind2
<IfModule suexec_module>
	SuexecUserGroup vufind2 vufind2
</IfModule>

<Directory /usr/local/vufind2/>
	FCGIWrapper /var/www/fcgid/php-fcgi .php
	Options +ExecCGI
</Directory>
EOF

a2ensite vufind2

cat > /etc/supervisor/conf.d/solr.conf <<EOF
[program:solr]
priority = 20
directory = /tmp
command = /app/run/solr
user = vufind2
autostart = false
autorestart = true
stdout_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
stderr_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
EOF

