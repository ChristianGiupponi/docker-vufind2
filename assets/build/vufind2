#!/bin/bash

# install CodeSniffer
pear install pear/PHP_CodeSniffer

# install phpunit
wget -qO /usr/local/bin/phpunit https://phar.phpunit.de/phpunit.phar
chmod +x /usr/local/bin/phpunit

# install phing
wget -qO /usr/local/bin/phing http://www.phing.info/get/phing-latest.phar
chmod +x /usr/local/bin/phing

# install php-cs-fixer
wget -qO /usr/local/bin/php-cs-fixer http://get.sensiolabs.org/php-cs-fixer.phar
chmod +x /usr/local/bin/php-cs-fixer

# install grunt
update-alternatives --install /usr/bin/node nodejs /usr/bin/nodejs 100
wget -qO - https://www.npmjs.com/install.sh | sh
npm install -g grunt-cli

cat > /etc/supervisor/conf.d/solr.conf <<EOF
[program:solr]
priority = 20
directory = /tmp
command = ${APP_HOME}/vufind.sh run
environment = VUFIND_HOME="${APP_HOME}"
user = dev
autostart = false
autorestart = true
stdout_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
stderr_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
EOF

cat > /etc/supervisor/conf.d/grunt-watch.conf <<EOF
[program:grunt-watch]
priority = 20
directory = /usr/local/vufind2
command = grunt watch
user = dev
autostart = true
autorestart = true
stdout_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
stderr_logfile = ${LOG_DIR}/supervisor/%(program_name)s.log
EOF

cat >> /home/dev/.profile <<EOF
export VUFIND_HOME=${APP_HOME}
export VUFIND_LOCAL_DIR="${APP_HOME}/local"
EOF

# override apache-config to match vufinds workingdirectory
cat >/etc/apache2/sites-available/99-app <<EOF
Alias / /${APP_HOME}/
<IfModule suexec_module>
	SuexecUserGroup dev dev
</IfModule>

<Directory /${APP_HOME}>
	FCGIWrapper /var/www/fcgid/php-fcgi .php
	Options +ExecCGI
	AllowOverride All
</Directory>
EOF